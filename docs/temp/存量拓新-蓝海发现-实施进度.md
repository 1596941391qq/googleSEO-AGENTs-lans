# 存量拓新 vs 蓝海发现 - 实施进度

**创建时间**: 2026-01-02  
**最后更新**: 2026-01-02  
**状态**: 基本完成，待测试

---

## 📋 项目概述

### 目标

将关键词挖掘功能分离为两种独立模式：

1. **蓝海发现 (Blue Ocean Discovery)**: 从种子关键词出发，发现弱竞争机会
2. **存量拓新 (Existing Website Audit)**: 分析现有网站，发现未被利用的流量空间

### 核心原则

- 两种模式完全独立，互不依赖
- 蓝海发现：只需要关键词，不需要网站
- 存量拓新：只需要网站，不需要关键词
- 清理所有混用逻辑

---

## ✅ 已完成

### Phase 1: 基础修复

- [x] 创建进度文档
- [x] 修复 WebsiteSelector 显示 URL（从 title/domain 改为 url）

### Phase 2: Prompt 管理

- [x] 在 `services/prompts/index.ts` 添加存量拓新 prompt
- [x] 添加 `EXISTING_WEBSITE_AUDIT_PROMPTS` 常量（支持中英文）
- [x] 添加 `getExistingWebsiteAuditPrompt` 函数

### Phase 3: Agent 实现

- [x] 创建 `api/_shared/agents/agent-1-website-audit.ts`
- [x] 实现网站内容获取逻辑（使用 Firecrawl scrapeWebsite）
- [x] 实现竞争对手关键词获取（使用 SE Ranking getDomainKeywords 和 getDomainCompetitors）
- [x] 实现 AI 分析逻辑（调用 Gemini API）
- [x] 创建 `api/website-audit.ts` API 端点

### Phase 4: 前端集成

- [x] 在 App.tsx 添加模式选择器（蓝海发现 vs 存量拓新）
- [x] 根据模式显示/隐藏输入组件
  - 蓝海发现：显示关键词输入框
  - 存量拓新：显示网站选择器（已选择时显示分析按钮）
- [x] 添加 `startWebsiteAudit` 函数
- [x] 修改 `startMining` 支持模式分支
- [x] 添加存量拓新模式的 UI（网站选择提示、分析按钮）

### Phase 5: 清理重构

- [x] 在 startMining 中添加模式检查，避免混用
- [ ] 检查其他可能的混用逻辑
- [ ] 更新相关类型定义（如需要）
- [ ] 测试两种模式独立运行

---

## 📝 实施详情

### 1. WebsiteSelector 修复

**文件**: `components/WebsiteSelector.tsx`

- 修改显示逻辑：从 `website.title || website.domain` 改为 `website.url`
- 保持其他功能不变

### 2. Prompt 添加

**文件**: `services/prompts/index.ts`

- 添加 `EXISTING_WEBSITE_AUDIT_PROMPTS.base` 对象
- 支持中英文两种语言
- Prompt 包含：
  - 现有内容分析逻辑
  - 竞争对手关键词分析逻辑
  - 流量空间识别逻辑
  - 输出格式规范

### 3. Agent 实现

**文件**: `api/_shared/agents/agent-1-website-audit.ts`

- 函数：`auditWebsiteForKeywords(options)`
- 步骤：
  1. 使用 Firecrawl 获取网站内容
  2. 使用 SE Ranking 获取竞争对手关键词
  3. 构建 AI Prompt（使用 prompts/index.ts 中的 prompt）
  4. 调用 Gemini API 分析
  5. 解析并返回关键词机会列表

### 4. API 端点

**文件**: `api/website-audit.ts`

- 端点：`POST /api/website-audit`
- 参数：websiteId, websiteUrl, websiteDomain, targetLanguage, uiLanguage, industry, wordsPerRound
- 返回：keywords, rawResponse, analysis

### 5. 前端集成

**文件**: `App.tsx`

- 添加 `miningMode` 状态：`'blue-ocean' | 'existing-website-audit'`
- 在 input 页面添加模式选择器（两个按钮）
- 根据模式显示不同 UI：
  - 蓝海发现：显示关键词输入框、设置面板
  - 存量拓新：显示网站选择器、分析按钮
- 修改 `startMining`：
  - 添加模式检查
  - 蓝海发现模式：使用现有逻辑
  - 存量拓新模式：调用 `startWebsiteAudit`
- 添加 `startWebsiteAudit` 函数：
  - 验证网站选择
  - 调用 `/api/website-audit` API
  - 处理结果并更新状态

---

## 🔄 待完成

### 测试与优化

- [ ] 测试蓝海发现模式（确保不受影响）
- [ ] 测试存量拓新模式（端到端测试）
- [ ] 测试模式切换
- [ ] 测试错误处理

### 清理工作

- [ ] 检查是否有其他地方混用了两种模式
- [ ] 检查类型定义是否需要更新
- [ ] 修复 linter 错误（Badge 组件类型问题，非本次引入）

---

## 🐛 已知问题

1. **Badge 组件类型错误**（非本次引入）
   - 位置：`components/WebsiteSelector.tsx` 第 224、272 行
   - 影响：TypeScript 类型检查错误，但不影响运行
   - 优先级：低

---

## 📚 相关文件

### 新增文件

- `api/_shared/agents/agent-1-website-audit.ts` - 存量拓新 Agent
- `api/website-audit.ts` - 存量拓新 API 端点
- `docs/temp/存量拓新-蓝海发现-实施进度.md` - 本文档

### 修改文件

- `components/WebsiteSelector.tsx` - 显示 URL
- `services/prompts/index.ts` - 添加存量拓新 prompt
- `App.tsx` - 添加模式选择和分支逻辑

### 相关文件（未修改）

- `api/_shared/agents/agent-1-keyword-mining.ts` - 蓝海发现 Agent（保持不变）
- `api/_shared/services/keyword-mining-service.ts` - 蓝海发现服务（保持不变）

---

## 🎯 验收标准

### 功能验收

- [x] 用户可以选择"蓝海发现"模式，只输入关键词即可挖掘
- [x] 用户可以选择"存量拓新"模式，只选择网站即可分析
- [x] 两种模式的结果可以正确显示
- [x] WebsiteSelector 显示网站 URL
- [ ] 两种模式完全独立，互不影响

### 代码验收

- [x] Prompt 统一在 prompts/index.ts 管理
- [x] 两种模式有独立的 Agent
- [x] 前端有明确的模式选择 UI
- [ ] 没有混用逻辑（待全面检查）
- [ ] 代码通过 lint 检查（Badge 类型问题待修复）

---

## 💡 技术决策

1. **Prompt 管理**: 统一在 `services/prompts/index.ts`，方便维护 ✅
2. **Agent 分离**: 创建独立的 `agent-1-website-audit.ts`，不修改现有的 `agent-1-keyword-mining.ts` ✅
3. **模式选择**: 在 UI 层面明确区分，避免用户混淆 ✅
4. **向后兼容**: 默认模式为"蓝海发现"，保持现有功能可用 ✅
5. **API 设计**: 创建独立的 `/api/website-audit` 端点，不混用 ✅

---

## 📅 时间线

- **Day 1 (今天)**:
  - ✅ 修复显示 + 添加 prompt + 创建 agent
  - ✅ 前端集成 + 修改流程
  - ⏳ 清理重构 + 测试（进行中）

---

## 🔗 相关文档

- [新功能.md](../step/新功能.md) - 产品需求
- [PHASE2_IMPLEMENTATION_PLAN.md](../step/PHASE2_IMPLEMENTATION_PLAN.md) - 实施计划

---

## 📌 注意事项

1. **存量拓新模式不需要种子关键词**，只需要网站信息
2. **蓝海发现模式不需要网站信息**，只需要种子关键词
3. 两种模式的结果格式统一（都是 KeywordData[]），便于统一展示
4. 存量拓新模式会调用 Firecrawl 和 SE Ranking API，注意 API 限制和成本
